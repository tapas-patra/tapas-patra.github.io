-- Drop the existing function first
DROP FUNCTION IF EXISTS hybrid_search(text, vector, float, int);

-- Create the function with correct syntax
CREATE OR REPLACE FUNCTION hybrid_search(
  query_text TEXT,
  query_embedding VECTOR(1024),
  match_threshold FLOAT,
  match_count INT
)
RETURNS TABLE (
  id BIGINT,
  content TEXT,
  metadata JSONB,
  similarity FLOAT
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  (
    -- Get results based on embedding similarity
    SELECT 
      documents.id,
      documents.content,
      documents.metadata,
      1 - (embeddings.embedding <=> query_embedding) AS similarity
    FROM embeddings
    JOIN documents ON embeddings.document_id = documents.id
    WHERE 1 - (embeddings.embedding <=> query_embedding) > match_threshold
    
    UNION ALL
    
    -- Get results based on text search
    SELECT
      documents.id,
      documents.content,
      documents.metadata,
      0.6 AS similarity -- Set a lower similarity score for text matches
    FROM documents
    WHERE 
      documents.content ILIKE '%' || query_text || '%'
      -- Exclude documents that likely matched in the embedding query
      AND documents.id NOT IN (
        SELECT 
          documents.id
        FROM embeddings
        JOIN documents ON embeddings.document_id = documents.id
        WHERE 1 - (embeddings.embedding <=> query_embedding) > match_threshold
        LIMIT match_count
      )
  )
  -- Order and limit the combined results
  ORDER BY similarity DESC
  LIMIT match_count;
END;
$$;
